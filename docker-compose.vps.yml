version: '3.8'

services:
  # --- Applications ---
  tpml-app:
    # build:  <-- On remplace le build local par l'image distante pour Watchtower
    #   context: .
    #   dockerfile: Dockerfile
    image: ghcr.io/roketag33/tpml:latest # Image construite par GitHub Actions
    ports:
      - "8501:8501"  # Streamlit
    environment:
      - MONGO_URI=mongodb://mongo1:27017,mongo2:27017,mongo3:27017/?replicaSet=rs0
      - CASSANDRA_HOST=cassandra
      - REDIS_HOST=redis
    depends_on:
      - mongo1
      - mongo2
      - mongo3
      - cassandra
      - redis
    networks:
      - tpml-network
      - proxy
    restart: unless-stopped
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
      - "com.centurylinklabs.watchtower.scope=tpml-scope"
      # --- Traefik Configuration ---
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"
      - "traefik.http.routers.tpml-app.rule=Host(`nosql.lootopia-server.roketlab.duckdns.org`)"
      - "traefik.http.routers.tpml-app.entrypoints=websecure"
      - "traefik.http.routers.tpml-app.tls.certresolver=myresolver" # Adaptez 'myresolver' si votre resolver s'appelle autrement (ex: letsencrypt)
      - "traefik.http.services.tpml-app.loadbalancer.server.port=8501"

  # --- NoSQL Document: MongoDB Replica Set ---
  mongo1:
    image: mongo:latest
    container_name: tpml-mongo1
    command: ["--replSet", "rs0", "--bind_ip_all", "--port", "27017"]
    volumes:
      - mongo1_data:/data/db
    networks:
      - tpml-network
    restart: always
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  mongo2:
    image: mongo:latest
    container_name: tpml-mongo2
    command: ["--replSet", "rs0", "--bind_ip_all", "--port", "27017"]
    volumes:
      - mongo2_data:/data/db
    networks:
      - tpml-network
    restart: always
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  mongo3:
    image: mongo:latest
    container_name: tpml-mongo3
    command: ["--replSet", "rs0", "--bind_ip_all", "--port", "27017"]
    volumes:
      - mongo3_data:/data/db
    networks:
      - tpml-network
    restart: always
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  # --- NoSQL Wide Column: Cassandra ---
  cassandra:
    image: cassandra:latest
    container_name: tpml-cassandra
    ports:
      - "9042:9042"
    environment:
      - CASSANDRA_CLUSTER_NAME=TPMLCluster
      - CASSANDRA_DC=dc1
      - CASSANDRA_ENDPOINT_SNITCH=GossipingPropertyFileSnitch
    volumes:
      - cassandra_data:/var/lib/cassandra
    networks:
      - tpml-network
    restart: always
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
    healthcheck:
      test: ["CMD-SHELL", "[ $$(nodetool statusgossip) = running ] || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5

  # --- NoSQL Key-Value: Redis ---
  redis:
    image: redis:latest
    container_name: tpml-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - tpml-network
    restart: always
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  # --- Auto-Updater: Watchtower ---
  watchtower:
    image: containrrr/watchtower
    container_name: watchtower
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_POLL_INTERVAL=300 # VÃ©rifie toutes les 5 minutes
      - WATCHTOWER_LABEL_ENABLE=true
      - WATCHTOWER_SCOPE=tpml-scope # ISOLATION TOTALE
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
      - "com.centurylinklabs.watchtower.scope=tpml-scope"
    networks:
      - tpml-network
    restart: always

volumes:
  mongo1_data:
  mongo2_data:
  mongo3_data:
  cassandra_data:
  redis_data:

networks:
  tpml-network:
    driver: bridge
  proxy:
    external: true
